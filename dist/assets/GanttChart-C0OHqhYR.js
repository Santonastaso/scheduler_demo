import{r as u,j as e,R as F,E as ne}from"./vendor-react-D_9RvGEK.js";import{n as oe,s as Y,t as re,a as ie,f as k,u as ee,b as le,c as ce,B as ae,d as J,e as de,A as ue,g as me,h as he}from"./index-D4en6Qau.js";import{u as ge}from"./vendor-react-query-C-U1ibBl.js";function O(t,s,a){const[j,r]=oe(a?.in,t,s);return+Y(j)==+Y(r)}function pe(t,s){const a=re(t,s?.in);return a.setHours(23,59,59,999),a}function ye(t,s,a){return ie(t,-1,a)}const fe=({currentDate:t,onNavigateToNextDay:s,isDragOver:a})=>{const[j,r]=u.useState(!1),[n,l]=u.useState(null),p=ie(t,1),b=k(p,"yyyy-MM-dd"),{setNodeRef:o}=ee({id:"next-day-drop-zone",data:{type:"next-day",targetDate:p,currentDate:t}});u.useEffect(()=>{if(a&&!n){const v=setTimeout(()=>{s(),l(null)},1600);l(v)}else!a&&n&&(clearTimeout(n),l(null));return()=>{n&&clearTimeout(n)}},[a,s,n]);const c=u.useCallback(()=>{r(!0)},[]),m=u.useCallback(()=>{r(!1)},[]),d=u.useCallback(()=>{n&&(clearTimeout(n),l(null)),s()},[s,n]),g=a||j||n;return e.jsxs("div",{ref:o,className:`next-day-drop-zone ${g?"active":""}`,onMouseEnter:c,onMouseLeave:m,onClick:d,title:`Trascina qui per andare al giorno successivo (${b})`,children:[e.jsx("div",{className:"next-day-content",children:e.jsx("div",{className:"next-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"})})})}),e.jsx("div",{className:"next-day-bg-effect"}),g&&e.jsx("div",{className:"next-day-pulse"})]})},xe=({currentDate:t,onNavigateToPreviousDay:s,isDragOver:a})=>{const[j,r]=u.useState(!1),[n,l]=u.useState(null),p=ye(t),b=k(p,"yyyy-MM-dd"),{setNodeRef:o}=ee({id:"previous-day-drop-zone",data:{type:"previous-day",targetDate:p,currentDate:t}});u.useEffect(()=>{if(a&&!n){const v=setTimeout(()=>{s(),l(null)},1600);l(v)}else!a&&n&&(clearTimeout(n),l(null));return()=>{n&&clearTimeout(n)}},[a,s,n]);const c=u.useCallback(()=>{r(!0)},[]),m=u.useCallback(()=>{r(!1)},[]),d=u.useCallback(()=>{n&&(clearTimeout(n),l(null)),s()},[s,n]),g=a||j||n;return e.jsxs("div",{ref:o,className:`previous-day-drop-zone ${g?"active":""}`,onMouseEnter:c,onMouseLeave:m,onClick:d,title:`Trascina qui per andare al giorno precedente (${b})`,children:[e.jsx("div",{className:"previous-day-content",children:e.jsx("div",{className:"previous-day-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"})})})}),e.jsx("div",{className:"previous-day-bg-effect"}),g&&e.jsx("div",{className:"previous-day-pulse"})]})},ve=F.memo(({machine:t,hour:s,minute:a,isUnavailable:j,hasScheduledTask:r,dropTargetId:n,slotId:l,dragPreview:p})=>{const{setNodeRef:b}=ee({id:`slot-${t.id}-${s}-${a}`,data:{machine:t,hour:s,minute:a,type:"slot",isUnavailable:j,hasScheduledTask:r}}),o=`time-slot${j?" unavailable":""}${r?" has-scheduled-task":""}`,c=n===l,m=(s-6)*4+Math.floor(a/15),d=p?.isActive&&p.machineId===t.id&&m>=p.startSlot&&m<p.startSlot+p.durationSlots;return e.jsxs("div",{ref:b,className:o,"data-hour":s,"data-minute":a,"data-machine-id":t.id,style:{position:"relative"},children:[c&&e.jsx("div",{className:"drop-indicator",style:{position:"absolute",top:"-1px",left:"-1px",right:"-1px",bottom:"-1px",border:"3px dashed #007bff",background:"rgba(0, 123, 255, 0.1)",pointerEvents:"none",zIndex:1e3,borderRadius:"4px"}}),d&&e.jsx("div",{className:"drag-preview-indicator",style:{position:"absolute",top:"0px",left:"0px",right:"0px",bottom:"0px",background:"rgba(59, 130, 246, 0.3)",border:"2px solid #3b82f6",pointerEvents:"none",zIndex:999,borderRadius:"2px"}})]})}),je=F.memo(({event:t,machine:s,currentDate:a,queryClient:j})=>{const[r,n]=u.useState(!0),l=ne(),{getSplitTaskInfo:p,splitTasksInfo:b}=J(),{schedulingLoading:o}=me(),{attributes:c,listeners:m,setNodeRef:d,transform:g,isDragging:v}=he({id:`event-${t.id}`,data:{event:t,type:"event",machine:s},disabled:r}),h=u.useMemo(()=>{const f=p(t.id),w=a||new Date,i=Y(w),U=pe(w),q=t.duration||1,te=t.progress||0,se=q*(te/100);if(!f||!f.segments){if(console.warn(`⚠️ No segment info for task ${t.odp_number}, creating fallback`),!t.scheduled_start_time)return null;const B=new Date(t.scheduled_start_time),T=t.time_remaining||t.duration||1,H=new Date(B.getTime()+T*60*60*1e3),x={start:B,end:H},z=O(x.start,a),L=O(x.end,a),P=x.start<U&&x.end>i;if(!z&&!L&&!P)return null;let S,D;if(z&&L){const C=x.start.getUTCHours(),_=x.start.getUTCMinutes(),A=x.end.getUTCHours(),M=x.end.getUTCMinutes(),Q=Math.max(6,C),K=Math.min(22,A),R=(Q-6)*4+Math.floor(_/15),X=(K-6)*4+Math.ceil(M/15);S=R*15,D=(X-R)*15}else if(z){const C=x.start.getUTCHours(),_=x.start.getUTCMinutes(),M=(Math.max(6,C)-6)*4+Math.floor(_/15);S=M*15,D=(64-M)*15}else if(L){const C=x.end.getUTCHours(),_=x.end.getUTCMinutes(),M=(Math.min(22,C)-6)*4+Math.ceil(_/15);S=0,D=M*15}else S=0,D=960;const V=te;return[{left:S,width:D,start:x.start,end:x.end,progress:V,duration:T}]}const G=[];let Z=0;for(const B of f.segments){const T=new Date(B.start),H=new Date(B.end),x=B.duration||0,z=O(T,a),L=O(H,a),P=T<U&&H>i;if(z||L||P){let S,D;if(z&&L){const C=T.getUTCHours(),_=T.getUTCMinutes(),A=H.getUTCHours(),M=H.getUTCMinutes(),Q=Math.max(6,C),K=Math.min(22,A),R=(Q-6)*4+Math.floor(_/15),X=(K-6)*4+Math.ceil(M/15);S=R*15,D=(X-R)*15}else if(z){const C=T.getUTCHours(),_=T.getUTCMinutes(),M=(Math.max(6,C)-6)*4+Math.floor(_/15);S=M*15,D=(64-M)*15}else if(L){const C=H.getUTCHours(),_=H.getUTCMinutes(),M=(Math.min(22,C)-6)*4+Math.ceil(_/15);S=0,D=M*15}else S=0,D=960;let V=0;se>Z&&(V=Math.min(x,se-Z)/x*100),G.push({left:S,width:D,start:T,end:H,progress:V,duration:x}),Z+=x}}return G.length>0?G:null},[t.id,a,p,b]),E=h?h.reduce((f,w)=>f+w.width,0):0,I=E<60,W=E<120,y=I&&E<80,$=E<40,N=u.useCallback(f=>{f.stopPropagation(),n(!r)},[r]);return!h||h.length===0?null:e.jsx(e.Fragment,{children:h.map((f,w)=>e.jsxs("div",{ref:w===0?d:void 0,style:{position:"absolute",left:`${f.left}px`,width:`${f.width}px`,zIndex:10,opacity:1,transition:"opacity 0.1s ease",pointerEvents:"auto"},className:`scheduled-event ${I?"very-small":""} ${W?"small":""} ${$?"extremely-narrow":""} ${h.length>1?"split-segment":""} ${o.taskId===t.id&&(o.isScheduling||o.isRescheduling||o.isShunting)?"processing":""}`,children:[e.jsx("div",{className:"event-content",children:e.jsxs("span",{className:"event-label",children:[t.odp_number,w===0&&(()=>{const i=p(t.id);return i&&i.wasSplit?e.jsx("span",{className:"split-indicator",title:`Task split into ${i.totalSegments} segments`,children:"✂️"}):null})()]})}),f.progress&&f.progress>0&&e.jsx("div",{className:"progress-bar-overlay",style:{width:`${Math.min(f.progress,100)}%`}}),w===0&&e.jsxs("div",{className:`event-controls ${y?"overlay":""}`,children:[e.jsx("button",{className:"event-btn info-btn",onClick:i=>{i.stopPropagation(),i.preventDefault()},onMouseDown:i=>{i.stopPropagation(),i.preventDefault()},onPointerDown:i=>{i.stopPropagation(),i.preventDefault()},title:`Codice Articolo: ${t.article_code||"Non specificato"}
Codice Articolo Esterno: ${t.external_article_code||"Non specificato"}
Nome Cliente: ${t.nome_cliente||"Non specificato"}
        Data Consegna: ${t.delivery_date?k(new Date(t.delivery_date),"yyyy-MM-dd"):"Non impostata"}
Quantità: ${t.quantity||"Non specificata"}
Altezza Busta: ${t.bag_height||"Non specificata"} mm
Passo Busta: ${t.bag_step||"Non specificato"} mm
Note Libere: ${t.user_notes||"Nessuna nota"}
Note ASD: ${t.asd_notes||"Nessuna nota"}
Material Global: ${t.material_availability_global||"N/A"}%
        ${t.scheduled_start_time?`Inizio Programmato: ${t.scheduled_start_time.replace("+00:00","")}`:"Non programmato"}
        ${t.scheduled_end_time?`Fine Programmata: ${t.scheduled_end_time.replace("+00:00","")}`:"Non programmato"}`,children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"#374151"},children:"i"})}),e.jsx("button",{className:"event-btn edit-btn",onClick:i=>{i.stopPropagation(),i.preventDefault(),l(`/backlog/${t.id}/edit`)},onMouseDown:i=>{i.stopPropagation(),i.preventDefault()},onPointerDown:i=>{i.stopPropagation(),i.preventDefault()},title:"Modifica e ricalcola",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:`event-btn lock-btn ${r?"locked":"unlocked"}`,onClick:N,title:r?"Sblocca per abilitare il trascinamento":"Blocca per disabilitare il trascinamento",children:r?e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"})}):e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22.53.14 1.08-.18 1.22-.72C9.44 6.06 10.72 5 12 5c1.66 0 3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"})})}),!r&&e.jsx("div",{className:"drag-handle",...m,...c,style:{transform:v?`translate3d(${g?.x||0}px, ${g?.y||0}px, 0)`:"none",zIndex:v?1001:20},title:"Trascina per riprogrammare",children:e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),!r&&e.jsx("button",{className:"event-btn unschedule-btn",onClick:async i=>{i.stopPropagation(),i.preventDefault();try{await J.getState().unscheduleTask(t.id,j)}catch(U){console.error("Error unscheduling task:",U)}},onMouseDown:i=>{i.stopPropagation(),i.preventDefault()},onPointerDown:i=>{i.stopPropagation(),i.preventDefault()},title:"Annulla programmazione e riporta al pool",children:e.jsx("span",{style:{fontSize:"14px",fontWeight:"bold",color:"white"},children:"×"})})]})]},`${t.id}-segment-${w}`))})}),be=F.memo(({machine:t,scheduledEvents:s,currentDate:a,unavailableByMachine:j,dropTargetId:r,hideMachineLabel:n=!1,queryClient:l,dragPreview:p})=>{const b=u.useMemo(()=>s.filter(c=>c.scheduled_machine_id===t.id),[s,t.id]),o=j[t.id];return e.jsxs("div",{className:"machine-row","data-machine-id":t.id,children:[!n&&e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:t.machine_name}),e.jsx("div",{className:"machine-city",children:t.work_center})]}),e.jsxs("div",{className:"machine-slots",children:[Array.from({length:64},(c,m)=>{const d=Math.floor(m/4)+6,g=m%4*15,v=o?o.has(d.toString()):!1,h=`${t.id}-${d}-${g}`;return e.jsx(ve,{machine:t,hour:d,minute:g,isUnavailable:v,hasScheduledTask:!1,dropTargetId:r,slotId:h,dragPreview:p},h)}),b.length>0&&b.map(c=>e.jsx(je,{event:c,machine:t,currentDate:a,queryClient:l},`event-${c.id}`))]})]})},(t,s)=>t.machine.id===s.machine.id&&t.machine.machine_name===s.machine.machine_name&&t.machine.work_center===s.machine.work_center&&t.scheduledEvents===s.scheduledEvents&&t.currentDate.getTime()===s.currentDate.getTime()&&t.unavailableByMachine===s.unavailableByMachine&&t.hideMachineLabel===s.hideMachineLabel&&t.queryClient===s.queryClient&&t.dragPreview===s.dragPreview),Me=F.memo(({machines:t,currentDate:s,scheduledTasks:a})=>{const j=ne(),{getSplitTaskInfo:r}=J(),n=u.useMemo(()=>{const c=de(s||new Date,{weekStartsOn:ue?.APP?.FIRST_DAY_OF_WEEK}),m=[];for(let d=0;d<7;d++){const g=new Date(c);g.setUTCDate(c.getUTCDate()+d),m.push(g)}return m},[s]),l=u.useCallback((o,c)=>a.filter(m=>{if(m.scheduled_machine_id!==o||!m.scheduled_start_time)return!1;const d=r(m.id);if(d&&d.segments&&d.segments.length>0){const g=new Date(c+"T00:00:00Z"),v=new Date(g.getTime()+1440*60*1e3);return d.segments.some(h=>{const E=new Date(h.start),I=new Date(h.end);return E<v&&I>g})}else return k(new Date(m.scheduled_start_time),"yyyy-MM-dd")===c}),[a,r]),p=u.useCallback(o=>{j(`/backlog/${o.id}/edit`)},[j]),b=u.useCallback((o,c)=>l(o,c).length,[l]);return e.jsxs("div",{className:"weekly-gantt-container",children:[e.jsxs("div",{className:"weekly-gantt-header",children:[e.jsx("div",{className:"machine-label-header",children:"Macchine"}),n.map(o=>e.jsxs("div",{className:"day-header-cell",children:[e.jsx("div",{className:"day-name",children:k(o,"yyyy-MM-dd")}),e.jsx("div",{className:"day-date",children:k(o,"yyyy-MM-dd")})]},o.toISOString()))]}),e.jsx("div",{className:"weekly-gantt-body",children:t.map(o=>e.jsxs("div",{className:"machine-week-row",children:[e.jsxs("div",{className:"machine-label",children:[e.jsx("div",{className:"machine-name",children:o.machine_name}),e.jsx("div",{className:"machine-city",children:o.work_center})]}),n.map(c=>{const m=k(c,"yyyy-MM-dd"),d=l(o.id,m),g=b(o.id,m),v=c.toDateString()===new Date().toDateString();return e.jsx("div",{className:`day-cell ${v?"today":""} ${g>0?"has-tasks":""}`,children:d.length>0?e.jsxs("div",{className:"day-tasks",children:[e.jsxs("div",{className:"day-task-count",children:[g," task",g!==1?"s":""]}),d.slice(0,3).map(h=>e.jsxs("div",{className:"day-task-item",onClick:()=>p(h),title:`${h.odp_number} - ${h.article_code||"Codice articolo FLEXI"} - ${h.time_remaining?Number(h.time_remaining).toFixed(1):(h.duration||1).toFixed(1)}h`,children:[e.jsx("span",{className:"task-odp",children:h.odp_number}),e.jsxs("span",{className:"task-duration",children:[h.time_remaining?Number(h.time_remaining).toFixed(1):(h.duration||1).toFixed(1),"h"]})]},h.id)),d.length>3&&e.jsxs("div",{className:"more-tasks-indicator",children:["+",d.length-3," more"]})]}):e.jsx("div",{className:"empty-day",children:"-"})},`${o.id}-${m}`)})]},o.id))})]})}),Se=F.memo(({machines:t,currentDate:s,dropTargetId:a,dragPreview:j,onNavigateToNextDay:r,onNavigateToPreviousDay:n})=>{const[l,p]=u.useState("Daily"),[b,o]=u.useState(null),{entities:c}=le(),m=u.useMemo(()=>c?.filter(y=>y.status==="SCHEDULED")||[],[c]),d=ge(),g=u.useMemo(()=>s?k(s,"yyyy-MM-dd"):k(new Date,"yyyy-MM-dd"),[s]),{data:v=[],isLoading:h,error:E}=ce(g),I=u.useMemo(()=>{if(l!=="Daily")return{};if(!Array.isArray(v)||v.length===0)return{};const y={};for(let $=0;$<v.length;$++){const N=v[$];N.machine_id&&N.unavailable_hours&&(y[N.machine_id]=new Set(N.unavailable_hours.map(f=>f.toString())))}return y},[v,l]),W=u.useMemo(()=>Array.from({length:16},(y,$)=>{const N=$+6;return e.jsx("div",{className:"time-slot-header hour-header",style:{gridColumn:`${$*4+1} / span 4`},children:N.toString().padStart(2,"0")},N)}),[]);return u.useEffect(()=>{const y=()=>{const N=new Date,f=N.getHours(),w=N.getMinutes();if(f>=6&&f<22){const i=(f-6)*4+Math.floor(w/15),U=w%15/15,q=i*15+U*15;o(q)}else o(null)};y();const $=setInterval(y,6e4);return()=>clearInterval($)},[]),!t||t.length===0?e.jsx("div",{className:"calendar-section",children:e.jsx("div",{className:"calendar-grid-container",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("h3",{children:"Nessuna macchina disponibile"}),e.jsx("p",{children:"Aggiungi macchine per visualizzare il programma."})]})})}):e.jsx("div",{className:"calendar-section",children:e.jsxs("div",{className:"gantt-chart-wrapper",children:[e.jsxs("div",{className:"gantt-controls-bar",children:[e.jsxs("div",{className:"gantt-date-navigation",children:[e.jsx(ae,{variant:"secondary",size:"sm",onClick:()=>n&&n(l),children:"<"}),e.jsx("span",{className:"current-date",children:s?k(s,"dd/MM/yyyy"):k(new Date,"dd/MM/yyyy")}),e.jsx(ae,{variant:"secondary",size:"sm",onClick:()=>r&&r(l),children:">"})]}),e.jsx("div",{className:"gantt-view-selector",children:e.jsxs("select",{value:l,onChange:y=>p(y.target.value),className:"view-selector flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",children:[e.jsx("option",{value:"Daily",children:"Vista Giornaliera"}),e.jsx("option",{value:"Weekly",children:"Vista Settimanale"})]})})]}),e.jsx("div",{className:"gantt-scroll-container",children:e.jsx("div",{className:"calendar-grid-container",children:l==="Daily"?e.jsxs("div",{className:"calendar-grid-with-day-navigation",children:[e.jsxs("div",{className:"machine-column-wrapper",children:[e.jsx("div",{className:"machine-label-header sticky-header",children:"Macchine"}),e.jsx("div",{className:"machine-labels-body",children:t.map(y=>e.jsxs("div",{className:"machine-label-only",children:[e.jsx("div",{className:"machine-name",children:y.machine_name}),e.jsx("div",{className:"machine-city",children:y.work_center})]},y.id))})]}),e.jsx(xe,{currentDate:s,onNavigateToPreviousDay:()=>n&&n(l),isDragOver:a==="previous-day-drop-zone"}),e.jsxs("div",{className:"time-grid-wrapper",children:[e.jsx("div",{className:"time-header-row sticky-header",children:W}),e.jsxs("div",{className:"time-grid-body",style:{position:"relative"},children:[t.map(y=>e.jsx(be,{machine:y,scheduledEvents:m,currentDate:s,unavailableByMachine:I,dropTargetId:a,hideMachineLabel:!0,queryClient:d,dragPreview:j},y.id)),b!==null&&e.jsx("div",{style:{position:"absolute",left:`${b}px`,top:0,bottom:0,width:"2px",backgroundColor:"#ef4444",zIndex:100,pointerEvents:"none"}})]})]}),e.jsx(fe,{currentDate:s,onNavigateToNextDay:()=>r&&r(l),isDragOver:a==="next-day-drop-zone"})]}):e.jsx(Me,{machines:t,currentDate:s,scheduledTasks:m})})})]})})});export{Se as default};
