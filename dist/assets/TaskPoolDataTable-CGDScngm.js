import{c,S as d,s as u,u as w,a as S,b as N,d as $,e as D,r as p,j as i,D as P,f as H,g as b}from"./index-CVSQpM8d.js";const T=new d(u,"machines"),R=new d(u,"odp_orders"),F=new d(u,"phases");c(T);c(R);c(F);class I extends d{constructor(){super(u,"machines")}async getMachinesWithFilters(e={}){return this.getAll({select:"id, machine_name, machine_type, work_center, status, capacity_per_hour, created_at, updated_at",orderBy:"machine_name",ascending:!0,...e})}async getMachinesByWorkCenter(e){return this.getByField("work_center",e,{orderBy:"machine_name"})}async getAvailableMachines(){return this.getByField("status","available",{orderBy:"machine_name"})}async updateMachineStatus(e,t){const o=["available","busy","maintenance","offline"];if(!o.includes(t))throw new Error(`Invalid status. Must be one of: ${o.join(", ")}`);return this.update(e,{status:t,updated_at:new Date().toISOString()})}async getMachineStats(){const e=await this.getAll({select:"status, work_center"}),t={total:e.length,byStatus:{},byWorkCenter:{}};return e.forEach(o=>{t.byStatus[o.status]=(t.byStatus[o.status]||0)+1,t.byWorkCenter[o.work_center]=(t.byWorkCenter[o.work_center]||0)+1}),t}}class L extends d{constructor(){super(u,"odp_orders")}async getOrdersWithFilters(e={}){return this.getAll({select:"*",orderBy:"created_at",ascending:!1,...e})}async getUnscheduledOrders(e=null){const t={status:"NOT SCHEDULED"};return e&&e!=="BOTH"&&(t.work_center=e),this.filterBy(t)}async getScheduledOrders(e=null){const t={status:"SCHEDULED"};return e&&e!=="BOTH"&&(t.work_center=e),this.filterBy(t)}async scheduleOrder(e,t){return this.update(e,{...t,status:"SCHEDULED",updated_at:new Date().toISOString()})}async unscheduleOrder(e){return this.update(e,{status:"NOT SCHEDULED",scheduled_start_time:null,scheduled_end_time:null,machine_id:null,updated_at:new Date().toISOString()})}async getOrdersByDateRange(e,t,o="scheduled_start_time"){return this.getByDateRange(e,t,o)}async filterBy(e){return(await this.getAll()).filter(o=>Object.entries(e).every(([h,l])=>l==null?!0:o[h]===l))}}class W extends d{constructor(){super(u,"phases")}async getPhasesWithFilters(e={}){return this.getAll({select:"*",orderBy:"phase_name",ascending:!0,...e})}async searchPhases(e,t={}){return this.search(e,["phase_name","description"],{orderBy:"phase_name",...t})}async getPhasesByWorkCenter(e){return this.getByField("work_center",e,{orderBy:"phase_name"})}}const K=new I,z=new L,U=new W;c(K);const E=c(z);c(U);const G=(s={})=>E.useList({orderBy:"created_at",ascending:!1,...s},{staleTime:120*1e3,onError:t=>{console.error("Failed to fetch orders:",t)}}),q=()=>{const s=E,{showSchedulerAlert:e}=w();return s.useDelete({onSuccess:()=>{e("Order deleted successfully","success")},onError:t=>{e(`Failed to delete order: ${t.message}`,"error")}})},Q=({task:s,isEditMode:e,schedulingLoading:t,conflictDialog:o})=>{S();const{updateEntity:h}=N();D("TaskPoolDataTable");const{attributes:l,listeners:y,setNodeRef:g}=H({id:`task-${s.id}`,data:{task:s,type:"task"},disabled:!e}),f=t.taskId===s.id&&(t.isScheduling||t.isRescheduling||t.isShunting);return i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("button",{className:"inline-flex items-center justify-center w-6 h-6 text-xs font-bold text-gray-600 bg-gray-100 rounded hover:bg-gray-200 transition-colors",onClick:n=>{n.stopPropagation(),n.preventDefault()},onMouseDown:n=>{n.stopPropagation(),n.preventDefault()},onPointerDown:n=>{n.stopPropagation(),n.preventDefault()},title:`Codice Articolo: ${s.article_code||"Non specificato"}
Codice Articolo Esterno: ${s.external_article_code||"Non specificato"}
Nome Cliente: ${s.nome_cliente||"Non specificato"}
Data Consegna: ${s.delivery_date?b(s.delivery_date):"Non impostata"}
Quantità: ${s.quantity||"Non specificata"}
Note Libere: ${s.user_notes||"Nessuna nota"}
Note ASD: ${s.asd_notes||"Nessuna nota"}
Material Global: ${s.material_availability_global||"N/A"}%
${s.scheduled_start_time?`Inizio Programmato: ${b(s.scheduled_start_time)}`:"Non programmato"}
${s.scheduled_end_time?`Fine Programmata: ${b(s.scheduled_end_time)}`:"Non programmato"}`,children:"i"}),e&&i.jsx("div",{ref:g,className:"drag-handle",...y,...l,title:"Trascina per programmare",style:{background:"#f3f4f6",border:"1px solid #d1d5db",minWidth:"30px",minHeight:"30px",display:"flex",alignItems:"center",justifyContent:"center",cursor:"grab",borderRadius:"4px",transition:"all 0.2s ease"},onMouseEnter:n=>{n.target.style.background="#e5e7eb",n.target.style.borderColor="#9ca3af"},onMouseLeave:n=>{n.target.style.background="#f3f4f6",n.target.style.borderColor="#d1d5db"},onClick:n=>{n.stopPropagation()},onMouseDown:n=>{n.stopPropagation()},children:i.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:i.jsx("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"})})}),f&&i.jsx("div",{className:"inline-flex items-center justify-center w-6 h-6",children:i.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-blue-600"})})]})};function J(){const s=S(),{selectedWorkCenter:e,isEditMode:t,conflictDialog:o,schedulingLoading:h,showConfirmDialog:l}=w(),{entities:y,setEntities:g}=N(),{setNodeRef:f}=$({id:"task-pool",data:{type:"pool"}}),{data:n=[],isLoading:j,error:O,refetch:_}=G(),C=q(),{handleAsync:B}=D("TaskPoolDataTable");p.useEffect(()=>{n.length>0&&g(n)},[n,g]),p.useEffect(()=>{const a=()=>{_()};return window.addEventListener("focus",a),()=>{window.removeEventListener("focus",a)}},[_]);const v=n.length>0?n:y,x=p.useMemo(()=>{let a=v.filter(r=>r.status!=="SCHEDULED"&&r.duration>0&&r.cost>0);return e&&e!=="BOTH"&&(a=a.filter(r=>r.work_center===e)),a},[v,e]),A=p.useMemo(()=>[{header:"ODP",accessorKey:"odp_number"},{header:"Codice Articolo",accessorKey:"article_code"},{header:"Nome Cliente",accessorKey:"nome_cliente"},{header:"Durata (h)",accessorKey:"duration",cell:({row:a})=>{const r=a.original.duration;return r?Number(r).toFixed(1):"N/A"}},{header:"Costo (€)",accessorKey:"cost",cell:({row:a})=>{const r=a.original.cost;return r?Number(r).toFixed(2):"N/A"}},{header:"Material ISP (%)",accessorKey:"material_availability_isp",cell:({row:a})=>{const r=a.original.material_availability_isp;if(typeof r!="number")return r||"N/A";const m=r<=39?"bg-gray-300":r<=69?"bg-yellow-400":"bg-green-400";return i.jsx("div",{className:`inline-flex items-center justify-center w-8 h-8 rounded-full ${m} text-black text-[10px] font-medium`,children:r})}},{header:"Material Lotti (%)",accessorKey:"material_availability_lotti",cell:({row:a})=>{const r=a.original.material_availability_lotti;if(typeof r!="number")return r||"N/A";const m=r<=39?"bg-gray-300":r<=69?"bg-yellow-400":"bg-green-400";return i.jsx("div",{className:`inline-flex items-center justify-center w-8 h-8 rounded-full ${m} text-black text-[10px] font-medium`,children:r})}},{header:"Material Global (%)",accessorKey:"material_availability_global",cell:({row:a})=>{const r=a.original.material_availability_global;if(typeof r!="number")return r||"N/A";const m=r<=39?"bg-gray-300":r<=69?"bg-yellow-400":"bg-green-400";return i.jsx("div",{className:`inline-flex items-center justify-center w-8 h-8 rounded-full ${m} text-black text-[10px] font-medium`,children:r})}},{header:"Note ASD",accessorKey:"asd_notes",cell:({row:a})=>{const r=a.original.asd_notes;return r?i.jsx("div",{className:"max-w-[200px] truncate text-[10px]",title:r,children:r}):"N/A"}},{header:"Gantt",id:"gantt_actions",cell:({row:a})=>i.jsx(Q,{task:a.original,isEditMode:t,schedulingLoading:h,conflictDialog:o})}],[t,h,o]),k=a=>{if(!a||!a.id){console.error("Invalid task data for editing:",a);return}s(`/backlog/${a.id}/edit`)},M=async a=>{l("Elimina Ordine",`Sei sicuro di voler eliminare "${a.odp_number}"? Questa azione non può essere annullata.`,async()=>{await B(async()=>{await C.mutateAsync(a.id)},{context:"Delete Order",fallbackMessage:"Eliminazione ordine fallita"})},"danger")};return i.jsx("div",{ref:f,id:"task_pool",className:"task-pool-table-container",children:j?i.jsxs("div",{className:"empty-state",children:[i.jsx("h3",{children:"Caricamento..."}),i.jsx("p",{children:"Recupero dati dal server..."})]}):O?i.jsxs("div",{className:"empty-state",children:[i.jsx("h3",{children:"Errore nel caricamento"}),i.jsx("p",{children:"Impossibile caricare i dati. Riprova più tardi."})]}):x.length>0?i.jsx(P,{data:x,columns:A,onEditRow:k,onDeleteRow:M,enableGlobalSearch:!1,enableFiltering:!1}):i.jsxs("div",{className:"empty-state",children:[i.jsx("h3",{children:"Nessun lavoro non programmato disponibile"}),i.jsx("p",{children:"I lavori devono avere durata e costo maggiori di 0 per essere visualizzati qui."})]})})}export{J as default};
